/**
 * 東証上場銘柄一覧データを JPX の公開 Excel ファイルから取得し、
 * TypeScript の静的データファイルとして出力するスクリプト。
 *
 * 使い方:
 *   node scripts/generate-tse-stocks.mjs
 *
 * JPX は毎月第3営業日に前月末時点のデータを更新する。
 * 定期的に再実行してデータを最新化できる。
 */

import { writeFile } from "node:fs/promises";
import { resolve, dirname } from "node:path";
import { fileURLToPath } from "node:url";
import * as XLSX from "xlsx";

const __dirname = dirname(fileURLToPath(import.meta.url));

const JPX_URL =
  "https://www.jpx.co.jp/markets/statistics-equities/misc/tvdivq0000001vg2-att/data_j.xls";

const OUTPUT_PATH = resolve(
  __dirname,
  "../src/lib/data/tse-stocks.ts",
);

async function downloadFile(url) {
  console.log(`Downloading: ${url}`);
  const res = await fetch(url);
  if (!res.ok) {
    throw new Error(`Failed to download: ${res.status} ${res.statusText}`);
  }
  return Buffer.from(await res.arrayBuffer());
}

function parseExcel(buffer) {
  const workbook = XLSX.read(buffer, { type: "buffer" });
  const sheetName = workbook.SheetNames[0];
  const sheet = workbook.Sheets[sheetName];
  const rows = XLSX.utils.sheet_to_json(sheet, { header: 1 });

  // JPX の Excel は以下のような構造:
  // 行0: ヘッダー (日付, コード, 銘柄名, 市場・商品区分, 33業種コード, ...)
  // 行1以降: データ

  // ヘッダー行を探す（"コード" カラムの位置を特定）
  let headerRowIndex = -1;
  let codeColIndex = -1;
  let nameColIndex = -1;

  for (let i = 0; i < Math.min(rows.length, 5); i++) {
    const row = rows[i];
    if (!Array.isArray(row)) continue;
    for (let j = 0; j < row.length; j++) {
      const cell = String(row[j] || "").trim();
      if (cell === "コード") {
        headerRowIndex = i;
        codeColIndex = j;
      }
      if (cell === "銘柄名") {
        nameColIndex = j;
      }
    }
    if (headerRowIndex >= 0) break;
  }

  if (headerRowIndex < 0 || codeColIndex < 0 || nameColIndex < 0) {
    // フォールバック: 一般的な JPX フォーマット (日付, コード, 銘柄名, ...)
    console.warn(
      "Could not find header row by name, using fallback column indices (1=code, 2=name)",
    );
    headerRowIndex = 0;
    codeColIndex = 1;
    nameColIndex = 2;
  }

  console.log(
    `Header at row ${headerRowIndex}, code col ${codeColIndex}, name col ${nameColIndex}`,
  );

  const stocks = [];
  const seen = new Set();

  for (let i = headerRowIndex + 1; i < rows.length; i++) {
    const row = rows[i];
    if (!Array.isArray(row)) continue;

    const code = String(row[codeColIndex] || "").trim();
    const name = String(row[nameColIndex] || "").trim();

    // 有効な銘柄コード (4桁の数字) のみ
    if (!/^\d{4}$/.test(code)) continue;
    if (!name) continue;

    const symbol = `${code}.T`;
    if (seen.has(symbol)) continue;
    seen.add(symbol);

    stocks.push({ symbol, name });
  }

  // コード順にソート
  stocks.sort((a, b) => a.symbol.localeCompare(b.symbol));

  return stocks;
}

function generateTypeScript(stocks) {
  const date = new Date().toISOString().split("T")[0];
  const entries = stocks
    .map(
      (s) =>
        `  { symbol: ${JSON.stringify(s.symbol)}, name: ${JSON.stringify(s.name)} }`,
    )
    .join(",\n");

  return `// This file is auto-generated by scripts/generate-tse-stocks.mjs
// Do not edit manually. Re-run the script to update.
// Generated: ${date}
// Total: ${stocks.length} stocks

export const TSE_STOCKS_METADATA = {
  generatedDate: "${date}",
  total: ${stocks.length},
} as const;

export const TSE_STOCKS: { symbol: string; name: string }[] = [
${entries},
];
`;
}

async function main() {
  const buffer = await downloadFile(JPX_URL);
  console.log(`Downloaded ${buffer.length} bytes`);

  const stocks = parseExcel(buffer);
  console.log(`Parsed ${stocks.length} stocks`);

  if (stocks.length < 100) {
    throw new Error(
      `Only ${stocks.length} stocks found, expected 3000+. Check the Excel format.`,
    );
  }

  const tsContent = generateTypeScript(stocks);
  await writeFile(OUTPUT_PATH, tsContent, "utf-8");
  console.log(`Written to ${OUTPUT_PATH}`);

  // サンプル表示
  console.log("\nSample entries:");
  for (const s of stocks.slice(0, 5)) {
    console.log(`  ${s.symbol} - ${s.name}`);
  }
  console.log(`  ... (${stocks.length - 5} more)`);
}

main().catch((err) => {
  console.error("Error:", err);
  process.exit(1);
});
